<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Challenge - AI Mock Interviewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Monaco Editor (VS Code editor) -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
    <style>
        body {
            height: 100vh;
            overflow: hidden;
        }

        .split-view {
            display: flex;
            height: calc(100vh - 60px);
        }

        .problem-panel {
            width: 40%;
            overflow-y: auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }

        .code-panel {
            width: 60%;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            background-color: #252526;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #editor {
            flex: 1;
            min-height: 400px;
        }

        .console-output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 150px;
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #3e3e42;
        }

        .problem-title {
            color: #4ec9b0;
            margin-bottom: 20px;
        }

        .difficulty-easy {
            color: #5cb85c;
        }

        .difficulty-medium {
            color: #f0ad4e;
        }

        .difficulty-hard {
            color: #d9534f;
        }

        .test-case {
            background-color: #2d2d30;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #007acc;
        }

        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }

        .test-passed {
            background-color: #1e4620;
            border-left: 3px solid #5cb85c;
        }

        .test-failed {
            background-color: #4a1e1e;
            border-left: 3px solid #d9534f;
        }

        .navbar-custom {
            background-color: #252526;
            border-bottom: 1px solid #3e3e42;
        }

        .loading-spinner {
            display: none;
        }

        .loading-spinner.active {
            display: inline-block;
        }

        pre {
            background-color: #2d2d30;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        code {
            color: #ce9178;
        }

        .hint-box {
            background-color: #2d2d30;
            padding: 15px;
            margin: 15px 0;
            border-left: 3px solid #f0ad4e;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="bi bi-code-slash"></i> Coding Challenge</span>
            <div class="d-flex gap-2">
                <a href="{{ url_for('main.start_interview') }}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Back to Interview
                </a>
                <a href="{{ url_for('main.upload_documents') }}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-house"></i> Home
                </a>
            </div>
        </div>
    </nav>

    <div class="split-view">
        <!-- Problem Description Panel -->
        <div class="problem-panel">
            <h2 class="problem-title">
                <span id="problemNumber">{{ problem.id }}.</span> 
                <span id="problemTitle">{{ problem.title }}</span>
            </h2>
            
            <div class="mb-3">
                <span class="badge difficulty-{{ problem.difficulty.lower() }}">{{ problem.difficulty }}</span>
                <span class="badge bg-secondary ms-2">{{ problem.category }}</span>
            </div>

            <div class="mb-4">
                <h5>Description</h5>
                <div id="problemDescription">{{ problem.description | safe }}</div>
            </div>

            <div class="mb-4">
                <h5>Examples</h5>
                {% for example in problem.examples %}
                <div class="test-case">
                    <strong>Example {{ loop.index }}:</strong><br>
                    <strong>Input:</strong> <code>{{ example.input }}</code><br>
                    <strong>Output:</strong> <code>{{ example.output }}</code><br>
                    {% if example.explanation %}
                    <strong>Explanation:</strong> {{ example.explanation }}
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="mb-4">
                <h5>Constraints</h5>
                <ul>
                    {% for constraint in problem.constraints %}
                    <li>{{ constraint }}</li>
                    {% endfor %}
                </ul>
            </div>

            {% if problem.hints %}
            <div class="hint-box">
                <h5><i class="bi bi-lightbulb"></i> Hints</h5>
                <ul id="hintsList" style="display: none;">
                    {% for hint in problem.hints %}
                    <li>{{ hint }}</li>
                    {% endfor %}
                </ul>
                <button id="showHintsBtn" class="btn btn-sm btn-warning">Show Hints</button>
            </div>
            {% endif %}

            <!-- Test Results -->
            <div id="testResults" class="mt-4"></div>
        </div>

        <!-- Code Editor Panel -->
        <div class="code-panel">
            <div class="editor-header">
                <div>
                    <select id="languageSelect" class="form-select form-select-sm d-inline-block w-auto">
                        <option value="python" selected>Python</option>
                        <option value="cpp">C++</option>
                        <option value="java">Java</option>
                    </select>
                    <span class="ms-3 text-light">
                        <i class="bi bi-clock"></i> 
                        <span id="timer">00:00</span>
                    </span>
                </div>
                <div>
                    <button id="resetBtn" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                    <button id="runBtn" class="btn btn-sm btn-success">
                        <i class="bi bi-play-fill"></i> Run Code
                        <span class="spinner-border spinner-border-sm loading-spinner ms-2" role="status"></span>
                    </button>
                    <button id="submitBtn" class="btn btn-sm btn-primary">
                        <i class="bi bi-check-circle"></i> Submit
                        <span class="spinner-border spinner-border-sm loading-spinner ms-2" role="status"></span>
                    </button>
                </div>
            </div>

            <div id="editor"></div>

            <div class="console-output">
                <strong><i class="bi bi-terminal"></i> Output:</strong>
                <pre id="output" class="mb-0 mt-2">// Your output will appear here...</pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>var require = { paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.nls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.js"></script>
    
    <script>
        // Problem data from backend
        const problemData = {{ problem | tojson }};
        
        // Starter code templates
        const starterCode = {
            python: `{{ problem.starter_code.python | safe }}`,
            cpp: `{{ problem.starter_code.cpp | safe }}`,
            java: `{{ problem.starter_code.java | safe }}`
        };

        // Initialize Monaco Editor
        let editor;
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: starterCode.python,
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: true },
                scrollBeyondLastLine: false,
                lineNumbers: 'on',
                roundedSelection: false,
                readOnly: false,
                cursorStyle: 'line',
                wordWrap: 'on'
            });
        });

        // Language selector
        const languageSelect = document.getElementById('languageSelect');
        languageSelect.addEventListener('change', (e) => {
            const lang = e.target.value;
            const monacoLang = lang === 'cpp' ? 'cpp' : lang;
            
            editor.setValue(starterCode[lang]);
            monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
        });

        // Timer
        let seconds = 0;
        const timerElement = document.getElementById('timer');
        setInterval(() => {
            seconds++;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            timerElement.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }, 1000);

        // Show hints
        document.getElementById('showHintsBtn')?.addEventListener('click', function() {
            document.getElementById('hintsList').style.display = 'block';
            this.style.display = 'none';
        });

        // Reset code
        document.getElementById('resetBtn').addEventListener('click', () => {
            const lang = languageSelect.value;
            editor.setValue(starterCode[lang]);
        });

        // Run code
        document.getElementById('runBtn').addEventListener('click', async () => {
            const code = editor.getValue();
            const language = languageSelect.value;
            const runBtn = document.getElementById('runBtn');
            const spinner = runBtn.querySelector('.loading-spinner');
            
            spinner.classList.add('active');
            runBtn.disabled = true;

            try {
                const response = await fetch('/run_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        language: language,
                        problem_id: problemData.id,
                        test_type: 'sample'
                    })
                });

                const result = await response.json();
                displayOutput(result);
            } catch (error) {
                displayOutput({ error: 'Failed to run code: ' + error.message });
            } finally {
                spinner.classList.remove('active');
                runBtn.disabled = false;
            }
        });

        // Submit code
        document.getElementById('submitBtn').addEventListener('click', async () => {
            const code = editor.getValue();
            const language = languageSelect.value;
            const submitBtn = document.getElementById('submitBtn');
            const spinner = submitBtn.querySelector('.loading-spinner');
            
            spinner.classList.add('active');
            submitBtn.disabled = true;

            try {
                const response = await fetch('/submit_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        language: language,
                        problem_id: problemData.id,
                        time_taken: seconds
                    })
                });

                const result = await response.json();
                displaySubmissionResults(result);
            } catch (error) {
                displayOutput({ error: 'Failed to submit code: ' + error.message });
            } finally {
                spinner.classList.remove('active');
                submitBtn.disabled = false;
            }
        });

        function displayOutput(result) {
            const outputElement = document.getElementById('output');
            
            if (result.error) {
                outputElement.innerHTML = `<span style="color: #f48771;">${escapeHtml(result.error)}</span>`;
            } else if (result.output) {
                outputElement.textContent = result.output;
            } else {
                outputElement.textContent = '// No output';
            }
        }

        function displaySubmissionResults(result) {
            const testResultsDiv = document.getElementById('testResults');
            
            if (result.error) {
                testResultsDiv.innerHTML = `
                    <div class="test-result test-failed">
                        <strong><i class="bi bi-x-circle"></i> Error:</strong><br>
                        ${escapeHtml(result.error)}
                    </div>
                `;
                return;
            }

            const passedTests = result.test_results.filter(t => t.passed).length;
            const totalTests = result.test_results.length;
            const allPassed = passedTests === totalTests;

            let html = `
                <div class="test-result ${allPassed ? 'test-passed' : 'test-failed'}">
                    <h5>
                        ${allPassed ? '<i class="bi bi-check-circle"></i> All Tests Passed!' : '<i class="bi bi-x-circle"></i> Some Tests Failed'}
                    </h5>
                    <p><strong>${passedTests}/${totalTests}</strong> test cases passed</p>
                </div>
            `;

            result.test_results.forEach((test, index) => {
                html += `
                    <div class="test-case">
                        <strong>Test Case ${index + 1}:</strong> 
                        ${test.passed ? '<span class="text-success">✓ Passed</span>' : '<span class="text-danger">✗ Failed</span>'}
                        <br>
                        <strong>Input:</strong> <code>${escapeHtml(test.input)}</code><br>
                        <strong>Expected:</strong> <code>${escapeHtml(test.expected)}</code><br>
                        <strong>Your Output:</strong> <code>${escapeHtml(test.actual)}</code>
                        ${test.passed ? '' : `<br><strong class="text-danger">Mismatch!</strong>`}
                    </div>
                `;
            });

            testResultsDiv.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to run
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('runBtn').click();
            }
            // Ctrl/Cmd + S to submit
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('submitBtn').click();
            }
        });
    </script>
</body>

</html>


